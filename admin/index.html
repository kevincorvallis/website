<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | Kevin Lee Photography</title>
    <meta name="robots" content="noindex, nofollow">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- Admin Styles -->
    <link rel="stylesheet" href="admin.css">
</head>
<body>
    <!-- Login Container -->
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <h1>Kevin Lee Admin</h1>
            <p>Sign in to manage your portfolio photos</p>

            <div class="error-message" id="loginError"></div>

            <form id="loginForm">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input
                        type="email"
                        id="email"
                        name="email"
                        placeholder="admin@example.com"
                        required
                        autocomplete="email"
                    >
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <input
                        type="password"
                        id="password"
                        name="password"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                        required
                        autocomplete="current-password"
                    >
                </div>

                <button type="submit" class="btn btn-primary">
                    Sign In
                </button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <!-- Header -->
        <header class="dashboard-header">
            <h1>Portfolio Admin</h1>
            <div class="dashboard-header-actions">
                <span class="user-info" id="userEmail"></span>
                <button class="btn btn-secondary btn-small" id="logoutBtn">Logout</button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="dashboard-content">
            <!-- Stats -->
            <section class="stats-grid">
                <div class="stat-card">
                    <p class="stat-card-label">Total Photos</p>
                    <p class="stat-card-value" id="totalPhotos">0</p>
                </div>
                <div class="stat-card">
                    <p class="stat-card-label">Gallery</p>
                    <p class="stat-card-value" id="galleryPhotos">0</p>
                </div>
                <div class="stat-card">
                    <p class="stat-card-label">Bento Grid</p>
                    <p class="stat-card-value" id="bentoPhotos">0</p>
                </div>
                <div class="stat-card">
                    <p class="stat-card-label">Featured</p>
                    <p class="stat-card-value" id="featuredPhotos">0</p>
                </div>
            </section>

            <!-- Upload Section -->
            <section class="upload-section">
                <h2>Upload Photos</h2>

                <div class="upload-zone" id="uploadZone">
                    <input type="file" id="fileInput" accept="image/*" multiple>
                    <div class="upload-zone-icon">üì∑</div>
                    <p class="upload-zone-text">Drop images here or click to upload</p>
                    <p class="upload-zone-hint">Supports JPG, PNG, WebP (max 10MB each)</p>
                </div>

                <div class="upload-settings">
                    <div class="form-group">
                        <label for="defaultSection">Default Section</label>
                        <select id="defaultSection">
                            <option value="gallery">Gallery</option>
                            <option value="bento">Bento Grid</option>
                            <option value="hero">Hero</option>
                            <option value="featured">Featured</option>
                            <option value="projects">Projects</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="defaultCategory">Default Category</label>
                        <select id="defaultCategory">
                            <option value="">None</option>
                            <option value="portrait">Portrait</option>
                            <option value="film">Film</option>
                            <option value="travel">Travel</option>
                            <option value="candid">Candid</option>
                            <option value="street">Street</option>
                            <option value="landscape">Landscape</option>
                        </select>
                    </div>
                </div>

                <div class="upload-progress" id="uploadProgress">
                    <div class="upload-progress-list" id="uploadProgressList"></div>
                </div>
            </section>

            <!-- Photos Section -->
            <section class="photos-section">
                <div class="photos-header">
                    <h2>Manage Photos</h2>
                    <div class="photos-filters">
                        <select id="sectionFilter">
                            <option value="">All Sections</option>
                            <option value="hero">Hero</option>
                            <option value="featured">Featured</option>
                            <option value="gallery">Gallery</option>
                            <option value="bento">Bento Grid</option>
                            <option value="projects">Projects</option>
                        </select>
                        <select id="categoryFilter">
                            <option value="">All Categories</option>
                            <option value="portrait">Portrait</option>
                            <option value="film">Film</option>
                            <option value="travel">Travel</option>
                            <option value="candid">Candid</option>
                            <option value="street">Street</option>
                            <option value="landscape">Landscape</option>
                        </select>
                    </div>
                </div>

                <p style="color: var(--admin-text-muted); font-size: 0.875rem; margin-bottom: 1rem;">
                    Filter by section to enable drag-and-drop reordering
                </p>

                <div class="photos-grid" id="photosGrid">
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-state-icon">üì∑</div>
                        <p class="empty-state-text">No photos yet</p>
                        <p class="empty-state-hint">Upload some photos to get started</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Edit Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Edit Photo</h2>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-preview">
                    <img id="editPreview" src="" alt="Preview">
                </div>

                <div class="form-group">
                    <label for="editTitle">Title</label>
                    <input type="text" id="editTitle" placeholder="Photo title">
                </div>

                <div class="form-group">
                    <label for="editAltText">Alt Text</label>
                    <textarea id="editAltText" rows="2" placeholder="Describe the image for accessibility"></textarea>
                </div>

                <div class="form-group">
                    <label for="editSection">Section</label>
                    <select id="editSection">
                        <option value="hero">Hero</option>
                        <option value="featured">Featured</option>
                        <option value="gallery">Gallery</option>
                        <option value="bento">Bento Grid</option>
                        <option value="projects">Projects</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="editCategory">Category</label>
                    <select id="editCategory">
                        <option value="">None</option>
                        <option value="portrait">Portrait</option>
                        <option value="film">Film</option>
                        <option value="travel">Travel</option>
                        <option value="candid">Candid</option>
                        <option value="street">Street</option>
                        <option value="landscape">Landscape</option>
                    </select>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="editFeatured">
                    <label for="editFeatured">Featured Photo</label>
                </div>
            </div>
            <div class="modal-footer">
                <div class="modal-footer-left">
                    <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                </div>
                <div class="modal-footer-right">
                    <button class="btn btn-primary" onclick="saveEditModal()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-body">
                <div class="confirm-dialog">
                    <div class="confirm-dialog-icon">‚ö†Ô∏è</div>
                    <h3>Delete Photo</h3>
                    <p>Are you sure you want to delete <strong id="deletePhotoName"></strong>? This action cannot be undone.</p>
                    <div class="confirm-dialog-actions">
                        <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                        <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Analytics -->
    <script defer src="/_vercel/insights/script.js"></script>
    <script defer src="/_vercel/speed-insights/script.js"></script>

    <!-- Scripts -->
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Sortable.js for drag reorder -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <!-- Config (inline to avoid MIME type issues with local server) -->
    <script>
    window.portfolioConfig = {
        CLOUDINARY_CLOUD_NAME: 'dvllhdgkf',
        CLOUDINARY_UPLOAD_PRESET: 'portfolio_unsigned',
        SUPABASE_URL: 'https://nmkavdrvgjkolreoexfe.supabase.co',
        SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ta2F2ZHJ2Z2prb2xyZW9leGZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczNTEyMjEsImV4cCI6MjA4MjkyNzIyMX0.VlmkBrD3i7eFfMg7SuZHACqa29r0GHZiU4FFzfB6P7Q',
        getCloudinaryUrl: function(publicId, options) {
            options = options || {};
            var transforms = ['q_' + (options.quality || 'auto'), 'f_' + (options.format || 'auto')];
            if (options.width) transforms.push('w_' + options.width);
            if (options.height) transforms.push('h_' + options.height);
            if ((options.width || options.height) && options.crop !== false) {
                transforms.push('c_' + (options.crop || 'fill'));
                if (options.gravity) transforms.push('g_' + options.gravity);
            }
            return 'https://res.cloudinary.com/' + this.CLOUDINARY_CLOUD_NAME + '/image/upload/' + transforms.join(',') + '/' + publicId;
        },
        PHOTO_CATEGORIES: ['portrait', 'film', 'travel', 'candid', 'street', 'landscape'],
        PHOTO_SECTIONS: ['hero', 'featured', 'gallery', 'bento', 'projects']
    };
    console.log('Portfolio config loaded inline');
    </script>

    <!-- Admin Logic -->
    <script src="admin.js"></script>

    <!-- Fallback handlers (in case admin.js has MIME type issues with local server) -->
    <script>
    (function() {
        var cfg = window.portfolioConfig;
        var supabaseClient = null;

        function getSupabase() {
            if (!supabaseClient && window.supabase && cfg) {
                supabaseClient = window.supabase.createClient(cfg.SUPABASE_URL, cfg.SUPABASE_ANON_KEY);
            }
            return supabaseClient;
        }

        function showDashboard(email) {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            document.getElementById('userEmail').textContent = email;
        }

        function showLogin() {
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('dashboard').classList.remove('active');
        }

        // Fallback photos loading
        async function fallbackLoadPhotos() {
            var sb = getSupabase();
            if (!sb) return;

            try {
                var result = await sb.from('photos').select('*').order('section').order('display_order');
                if (result.error) throw result.error;

                var photos = result.data || [];

                // Update stats
                document.getElementById('totalPhotos').textContent = photos.length;
                document.getElementById('galleryPhotos').textContent = photos.filter(function(p) { return p.section === 'gallery'; }).length;
                document.getElementById('bentoPhotos').textContent = photos.filter(function(p) { return p.section === 'bento'; }).length;
                document.getElementById('featuredPhotos').textContent = photos.filter(function(p) { return p.featured; }).length;

                // Render photos grid (basic)
                var grid = document.getElementById('photosGrid');
                if (photos.length === 0) {
                    grid.innerHTML = '<div class="empty-state" style="grid-column: 1 / -1;"><div class="empty-state-icon">üì∑</div><p class="empty-state-text">No photos yet</p><p class="empty-state-hint">Upload some photos to get started</p></div>';
                } else {
                    grid.innerHTML = photos.map(function(photo) {
                        var thumbUrl = cfg.getCloudinaryUrl ? cfg.getCloudinaryUrl(photo.cloudinary_id, { width: 400, height: 300, crop: 'fill' }) : photo.cloudinary_url;
                        return '<div class="photo-card" data-id="' + photo.id + '"><div class="photo-card-image"><img src="' + thumbUrl + '" alt="' + (photo.alt_text || photo.title || '') + '" loading="lazy"></div><div class="photo-card-content"><h3 class="photo-card-title">' + (photo.title || 'Untitled') + '</h3><div class="photo-card-meta"><span class="photo-card-badge">' + photo.section + '</span>' + (photo.category ? '<span class="photo-card-badge">' + photo.category + '</span>' : '') + '</div></div></div>';
                    }).join('');
                }
            } catch (err) {
                console.error('Failed to load photos:', err);
            }
        }

        document.addEventListener('DOMContentLoaded', async function() {
            var form = document.getElementById('loginForm');
            var logoutBtn = document.getElementById('logoutBtn');
            var sb = getSupabase();

            // Check for existing session
            if (sb) {
                try {
                    var sessionResult = await sb.auth.getSession();
                    if (sessionResult.data.session && sessionResult.data.session.user) {
                        showDashboard(sessionResult.data.session.user.email);
                        // Load photos if admin.js didn't load
                        if (typeof loadPhotos !== 'function') {
                            fallbackLoadPhotos();
                        }
                    }
                } catch (err) {
                    console.error('Session check error:', err);
                }
            }

            // Login form handler
            if (form) {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();

                    var email = document.getElementById('email').value;
                    var password = document.getElementById('password').value;
                    var errorEl = document.getElementById('loginError');
                    var sb = getSupabase();

                    if (!sb) {
                        errorEl.textContent = 'Supabase not loaded';
                        errorEl.classList.add('show');
                        return;
                    }

                    try {
                        var result = await sb.auth.signInWithPassword({ email: email, password: password });

                        if (result.error) {
                            errorEl.textContent = result.error.message;
                            errorEl.classList.add('show');
                            return;
                        }

                        showDashboard(result.data.user.email);

                        // Load photos
                        if (typeof loadPhotos === 'function') {
                            loadPhotos();
                        } else {
                            fallbackLoadPhotos();
                        }
                    } catch (err) {
                        errorEl.textContent = err.message || 'Login failed';
                        errorEl.classList.add('show');
                    }
                });
            }

            // Logout handler
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async function() {
                    var sb = getSupabase();
                    if (sb) {
                        await sb.auth.signOut();
                    }
                    showLogin();
                });
            }
        });
    })();
    </script>
</body>
</html>
