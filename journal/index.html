<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Day by Day - Your Personal Journal</title>
    <!-- Google Fonts for better typography -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- External CSS -->
    <link rel="stylesheet" href="styles.css">

    <!-- AWS Amplify for Cognito Authentication (loaded as ES module) -->

</head>
<body>
    <!-- Welcome Screen (hidden - users go directly to login) -->
    <div class="container" id="welcomeScreen" style="display: none;">
        <h1>Day by Day</h1>
        <p class="subtitle">Your personal space for reflection and growth</p>
        <div class="buttons">
            <button id="signInBtn" onclick="showSignIn()">Get Started</button>
        </div>
    </div>

    <!-- Loading Screen (shown while module loads) -->
    <div class="container" id="loadingScreen">
        <h2>Day by Day</h2>
        <p class="subtitle">Loading...</p>
        <div class="spinner"></div>
    </div>

    <!-- Sign In Container -->
    <div class="container" id="signInContainer" style="display: none;">
        <h2>Welcome Back</h2>
        <p class="subtitle">Sign in to continue your journey</p>

        <!-- Auth Forms Container -->
        <div id="authFormsContainer">
            <!-- Sign In Form -->
            <div id="signInForm" class="auth-form">
                <div class="form-group">
                    <input type="email" id="signInEmail" placeholder="Email" required>
                </div>
                <div class="form-group">
                    <input type="password" id="signInPassword" placeholder="Password" required>
                </div>
                <button type="button" class="primary-btn" onclick="signInWithEmail()">Sign In</button>
                <p class="auth-switch">Don't have an account? <a href="#" onclick="showSignUpForm()">Sign Up</a></p>
            </div>

            <!-- Sign Up Form (hidden by default) -->
            <div id="signUpForm" class="auth-form" style="display: none;">
                <div class="form-group">
                    <input type="email" id="signUpEmail" placeholder="Email" required>
                </div>
                <div class="form-group">
                    <input type="password" id="signUpPassword" placeholder="Password (min 8 chars)" required minlength="8">
                </div>
                <div class="form-group">
                    <input type="password" id="signUpPasswordConfirm" placeholder="Confirm Password" required>
                </div>
                <button type="button" class="primary-btn" onclick="signUpWithEmail()">Create Account</button>
                <p class="auth-switch">Already have an account? <a href="#" onclick="showSignInForm()">Sign In</a></p>
            </div>

            <!-- Verification Form (hidden by default) -->
            <div id="verificationForm" class="auth-form" style="display: none;">
                <div class="verification-header">
                    <div class="verification-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 8L10.89 13.26C11.2187 13.4793 11.6049 13.5963 12 13.5963C12.3951 13.5963 12.7813 13.4793 13.11 13.26L21 8M5 19H19C19.5304 19 20.0391 18.7893 20.4142 18.4142C20.7893 18.0391 21 17.5304 21 17V7C21 6.46957 20.7893 5.96086 20.4142 5.58579C20.0391 5.21071 19.5304 5 19 5H5C4.46957 5 3.96086 5.21071 3.58579 5.58579C3.21071 5.96086 3 6.46957 3 7V17C3 17.5304 3.21071 18.0391 3.58579 18.4142C3.96086 18.7893 4.46957 19 5 19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <h3>Check your email</h3>
                    <p class="verification-email">We sent a code to <strong id="verificationEmailDisplay"></strong></p>
                </div>
                <div class="code-input-container">
                    <input type="text" maxlength="1" class="code-digit" data-index="0" inputmode="numeric" pattern="[0-9]" autocomplete="one-time-code">
                    <input type="text" maxlength="1" class="code-digit" data-index="1" inputmode="numeric" pattern="[0-9]">
                    <input type="text" maxlength="1" class="code-digit" data-index="2" inputmode="numeric" pattern="[0-9]">
                    <input type="text" maxlength="1" class="code-digit" data-index="3" inputmode="numeric" pattern="[0-9]">
                    <input type="text" maxlength="1" class="code-digit" data-index="4" inputmode="numeric" pattern="[0-9]">
                    <input type="text" maxlength="1" class="code-digit" data-index="5" inputmode="numeric" pattern="[0-9]">
                </div>
                <input type="hidden" id="verificationCode">
                <button type="button" class="primary-btn" id="verifyBtn" onclick="handleConfirmSignUp()" disabled>Verify Email</button>
                <div class="resend-section">
                    <p id="resendText">Didn't receive the code? <a href="#" id="resendLink" onclick="resendCode()">Resend</a></p>
                    <p id="resendTimer" style="display: none;">Resend code in <span id="timerCount">60</span>s</p>
                </div>
            </div>

            <!-- Verification Success (hidden by default) -->
            <div id="verificationSuccess" class="auth-form" style="display: none;">
                <div class="verification-success">
                    <div class="success-checkmark">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="10" stroke="#4CAF50" stroke-width="2"/>
                            <path d="M8 12L11 15L16 9" stroke="#4CAF50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <h3>Email Verified!</h3>
                    <p>Your account has been verified successfully.</p>
                    <p class="redirect-text">Redirecting to sign in...</p>
                </div>
            </div>

            <!-- Divider -->
            <div class="auth-divider">
                <span>or</span>
            </div>

            <!-- Google Sign In -->
            <button type="button" class="google-btn" onclick="signInWithGoogle()">
                <svg width="18" height="18" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg">
                    <path d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z" fill="#4285F4"/>
                    <path d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z" fill="#34A853"/>
                    <path d="M3.964 10.71c-.18-.54-.282-1.117-.282-1.71s.102-1.17.282-1.71V4.958H.957C.347 6.173 0 7.548 0 9s.348 2.827.957 4.042l3.007-2.332z" fill="#FBBC05"/>
                    <path d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z" fill="#EA4335"/>
                </svg>
                Continue with Google
            </button>
        </div>

        <div id="loader" style="display:none;">
            <div class="spinner"></div>
            <p>Setting up your journal...</p>
        </div>
        <div id="authError" class="auth-error" style="display: none;"></div>
        <div class="auth-note">
            <p>Sign in with your email or Google account</p>
        </div>
    </div>

    <!-- Profile Setup for First-Time Users -->
    <div class="container profile-setup" id="profileSetup" style="display: none;">
        <h2>Let's get to know you better</h2>
        <p class="subtitle">Help us personalize your journaling experience</p>
        
        <form id="profileForm" class="profile-form">
            <div class="form-group">
                <label for="displayName">What would you like to be called?</label>
                <input type="text" id="displayName" name="displayName" placeholder="Your preferred name" required>
            </div>
            
            <div class="form-group">
                <label for="age">Your age (optional)</label>
                <select id="age" name="age">
                    <option value="">Prefer not to say</option>
                    <option value="18-25">18-25</option>
                    <option value="26-35">26-35</option>
                    <option value="36-45">36-45</option>
                    <option value="46-55">46-55</option>
                    <option value="56-65">56-65</option>
                    <option value="65+">65+</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="journalGoal">What brings you to journaling?</label>
                <select id="journalGoal" name="journalGoal" required>
                    <option value="">Select your main goal</option>
                    <option value="self-reflection">Self-reflection and mindfulness</option>
                    <option value="goal-tracking">Goal tracking and productivity</option>
                    <option value="emotional-wellness">Emotional wellness and stress relief</option>
                    <option value="creative-expression">Creative expression and writing</option>
                    <option value="memory-keeping">Memory keeping and life documentation</option>
                    <option value="habit-building">Habit building and personal growth</option>
                    <option value="other">Other</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="writingFrequency">How often do you plan to write?</label>
                <select id="writingFrequency" name="writingFrequency" required>
                    <option value="">Select frequency</option>
                    <option value="daily">Daily</option>
                    <option value="few-times-week">A few times a week</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                    <option value="when-inspired">When inspired</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="favoriteTime">When do you prefer to write?</label>
                <select id="favoriteTime" name="favoriteTime">
                    <option value="">No preference</option>
                    <option value="morning">Morning (6AM - 12PM)</option>
                    <option value="afternoon">Afternoon (12PM - 6PM)</option>
                    <option value="evening">Evening (6PM - 10PM)</option>
                    <option value="night">Night (10PM - 6AM)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="inspiration">What inspires you most?</label>
                <textarea id="inspiration" name="inspiration" placeholder="Share what motivates you, your interests, or what you'd like to explore in your journal..." rows="3"></textarea>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="primary-btn">Complete Setup</button>
                <button type="button" class="secondary-btn" onclick="skipProfile()">Skip for now</button>
            </div>
        </form>
    </div>

    <!-- Placeholder functions while module loads -->
    <script>
        // These will be replaced by the module once it loads
        window.signInWithEmail = window.signUpWithEmail = window.signInWithGoogle =
        window.handleConfirmSignUp = window.resendCode = window.skipProfile =
        window.showSignIn = window.showSignInForm = window.showSignUpForm = function() {
            console.log('Please wait, loading...');
        };
    </script>

    <!-- Cognito Auth and Application Logic -->
    <script type="module">
        // Import AWS Amplify v6 from esm.sh CDN
        import { Amplify } from 'https://esm.sh/aws-amplify@6';
        import { signIn, signUp, confirmSignUp, resendSignUpCode, signOut, getCurrentUser, fetchAuthSession, signInWithRedirect } from 'https://esm.sh/aws-amplify@6/auth';

        // Cognito Configuration
        const cognitoConfig = {
            userPoolId: 'us-west-1_81HBZnH92',
            userPoolClientId: '7t77oqaipn9hldtdpesvde3eka',
            region: 'us-west-1',
            domain: 'daybyday-journal.auth.us-west-1.amazoncognito.com'
        };

        // Determine the correct redirect URL based on current environment
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const currentOrigin = window.location.origin;
        const redirectSignIn = isLocalhost
            ? 'http://localhost/journal/dashboard.html'
            : `${currentOrigin}/journal/dashboard.html`;
        const redirectSignOut = isLocalhost
            ? 'http://localhost/journal/index.html'
            : `${currentOrigin}/journal/index.html`;

        Amplify.configure({
            Auth: {
                Cognito: {
                    userPoolId: cognitoConfig.userPoolId,
                    userPoolClientId: cognitoConfig.userPoolClientId,
                    loginWith: {
                        oauth: {
                            domain: cognitoConfig.domain,
                            scopes: ['openid', 'email', 'profile'],
                            redirectSignIn: [redirectSignIn],
                            redirectSignOut: [redirectSignOut],
                            responseType: 'code',
                            providers: ['Google']
                        }
                    }
                }
            }
        });

        // Current user state
        let currentUser = null;
        let pendingEmail = null;

        // Check if user profile exists
        function hasUserProfile(uid) {
            return localStorage.getItem(`user_profile_${uid}`) !== null;
        }

        // Save user profile
        function saveUserProfile(uid, profileData) {
            localStorage.setItem(`user_profile_${uid}`, JSON.stringify(profileData));
        }

        // Get user profile
        function getUserProfile(uid) {
            const profile = localStorage.getItem(`user_profile_${uid}`);
            return profile ? JSON.parse(profile) : null;
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // Navigation functions
        function showSignIn() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('signInContainer').style.display = 'block';
            document.getElementById('profileSetup').style.display = 'none';
            showSignInForm();
        }

        function showSignInForm() {
            document.getElementById('signInForm').style.display = 'block';
            document.getElementById('signUpForm').style.display = 'none';
            document.getElementById('verificationForm').style.display = 'none';
        }

        function showSignUpForm() {
            document.getElementById('signInForm').style.display = 'none';
            document.getElementById('signUpForm').style.display = 'block';
            document.getElementById('verificationForm').style.display = 'none';
        }

        function showVerificationForm() {
            document.getElementById('signInForm').style.display = 'none';
            document.getElementById('signUpForm').style.display = 'none';
            document.getElementById('verificationForm').style.display = 'block';
            document.getElementById('verificationSuccess').style.display = 'none';

            // Display the email the code was sent to
            if (pendingEmail) {
                document.getElementById('verificationEmailDisplay').textContent = pendingEmail;
            }

            // Clear and focus first input
            const codeInputs = document.querySelectorAll('.code-digit');
            codeInputs.forEach(input => input.value = '');
            codeInputs[0].focus();
            document.getElementById('verifyBtn').disabled = true;

            // Reset resend timer display
            document.getElementById('resendText').style.display = 'block';
            document.getElementById('resendTimer').style.display = 'none';
        }

        // Setup code input handlers
        function setupCodeInputs() {
            const codeInputs = document.querySelectorAll('.code-digit');

            codeInputs.forEach((input, index) => {
                // Handle input
                input.addEventListener('input', (e) => {
                    const value = e.target.value;

                    // Only allow numbers
                    if (!/^\d*$/.test(value)) {
                        e.target.value = '';
                        return;
                    }

                    // Auto-advance to next input
                    if (value && index < 5) {
                        codeInputs[index + 1].focus();
                    }

                    // Update hidden input and check if complete
                    updateVerificationCode();
                });

                // Handle backspace
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        codeInputs[index - 1].focus();
                    }
                });

                // Handle paste
                input.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const pastedData = e.clipboardData.getData('text').replace(/\D/g, '').slice(0, 6);

                    pastedData.split('').forEach((char, i) => {
                        if (codeInputs[i]) {
                            codeInputs[i].value = char;
                        }
                    });

                    // Focus appropriate input
                    const nextIndex = Math.min(pastedData.length, 5);
                    codeInputs[nextIndex].focus();

                    updateVerificationCode();
                });
            });
        }

        function updateVerificationCode() {
            const codeInputs = document.querySelectorAll('.code-digit');
            const code = Array.from(codeInputs).map(input => input.value).join('');
            document.getElementById('verificationCode').value = code;

            // Enable/disable verify button
            const verifyBtn = document.getElementById('verifyBtn');
            verifyBtn.disabled = code.length !== 6;

            // Auto-submit when complete
            if (code.length === 6) {
                handleConfirmSignUp();
            }
        }

        let resendTimerId = null;

        function startResendTimer() {
            document.getElementById('resendText').style.display = 'none';
            document.getElementById('resendTimer').style.display = 'block';

            let seconds = 60;
            document.getElementById('timerCount').textContent = seconds;

            if (resendTimerId) clearInterval(resendTimerId);

            resendTimerId = setInterval(() => {
                seconds--;
                document.getElementById('timerCount').textContent = seconds;

                if (seconds <= 0) {
                    clearInterval(resendTimerId);
                    document.getElementById('resendText').style.display = 'block';
                    document.getElementById('resendTimer').style.display = 'none';
                }
            }, 1000);
        }

        function showVerificationSuccess() {
            document.getElementById('verificationForm').style.display = 'none';
            document.getElementById('verificationSuccess').style.display = 'block';

            // Redirect to sign in after animation
            setTimeout(() => {
                showSignInForm();
                document.getElementById('verificationSuccess').style.display = 'none';
                if (pendingEmail) {
                    document.getElementById('signInEmail').value = pendingEmail;
                }
            }, 2000);
        }

        function showProfileSetup(user) {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('signInContainer').style.display = 'none';
            document.getElementById('profileSetup').style.display = 'block';

            // Pre-fill display name: prioritize Google name > given_name > email prefix
            const displayName = user.name ||
                               user.givenName ||
                               (user.email?.split('@')[0]) ||
                               (user.username?.includes('@') ? user.username.split('@')[0] : user.username) ||
                               '';
            document.getElementById('displayName').value = displayName;
        }

        // Auth functions
        async function signInWithEmail() {
            const email = document.getElementById('signInEmail').value;
            const password = document.getElementById('signInPassword').value;

            if (!email || !password) {
                showError('Please enter email and password');
                return;
            }

            try {
                document.getElementById('loader').style.display = 'block';
                const result = await signIn({ username: email, password });

                // Amplify v6 returns nextStep instead of isSignedIn
                if (result.isSignedIn || result.nextStep?.signInStep === 'DONE') {
                    await handleSuccessfulAuth();
                }
            } catch (error) {
                console.error('Sign in error:', error);
                if (error.name === 'UserNotConfirmedException') {
                    pendingEmail = email;
                    showVerificationForm();
                    showError('Please verify your email first');
                } else {
                    showError(error.message || 'Sign in failed');
                }
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        async function signUpWithEmail() {
            const email = document.getElementById('signUpEmail').value;
            const password = document.getElementById('signUpPassword').value;
            const confirmPassword = document.getElementById('signUpPasswordConfirm').value;

            if (!email || !password) {
                showError('Please fill in all fields');
                return;
            }

            if (password !== confirmPassword) {
                showError('Passwords do not match');
                return;
            }

            if (password.length < 8) {
                showError('Password must be at least 8 characters');
                return;
            }

            try {
                document.getElementById('loader').style.display = 'block';
                const result = await signUp({
                    username: email,
                    password,
                    options: {
                        userAttributes: {
                            email
                        }
                    }
                });

                pendingEmail = email;

                if (result.nextStep.signUpStep === 'CONFIRM_SIGN_UP') {
                    showVerificationForm();
                }
            } catch (error) {
                console.error('Sign up error:', error);
                showError(error.message || 'Sign up failed');
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        async function handleConfirmSignUp() {
            const code = document.getElementById('verificationCode').value;

            if (!code || code.length !== 6 || !pendingEmail) {
                showError('Please enter the 6-digit verification code');
                return;
            }

            try {
                document.getElementById('verifyBtn').disabled = true;
                document.getElementById('verifyBtn').textContent = 'Verifying...';

                await confirmSignUp({
                    username: pendingEmail,
                    confirmationCode: code
                });

                // Show success animation then redirect
                showVerificationSuccess();
            } catch (error) {
                console.error('Confirmation error:', error);

                // Clear inputs on error
                const codeInputs = document.querySelectorAll('.code-digit');
                codeInputs.forEach(input => input.value = '');
                codeInputs[0].focus();
                document.getElementById('verificationCode').value = '';

                // Show specific error messages
                if (error.name === 'CodeMismatchException') {
                    showError('Invalid code. Please check and try again.');
                } else if (error.name === 'ExpiredCodeException') {
                    showError('Code expired. Please request a new one.');
                } else {
                    showError(error.message || 'Verification failed');
                }
            } finally {
                document.getElementById('verifyBtn').disabled = false;
                document.getElementById('verifyBtn').textContent = 'Verify Email';
            }
        }

        async function resendCode() {
            if (!pendingEmail) {
                showError('Please enter your email first');
                return;
            }

            try {
                await resendSignUpCode({ username: pendingEmail });

                // Start cooldown timer
                startResendTimer();

                // Clear existing code inputs
                const codeInputs = document.querySelectorAll('.code-digit');
                codeInputs.forEach(input => input.value = '');
                codeInputs[0].focus();
                document.getElementById('verificationCode').value = '';
                document.getElementById('verifyBtn').disabled = true;

            } catch (error) {
                console.error('Resend error:', error);
                showError(error.message || 'Failed to resend code');
            }
        }

        async function signInWithGoogle() {
            try {
                document.getElementById('loader').style.display = 'block';
                await signInWithRedirect({ provider: 'Google' });
            } catch (error) {
                console.error('Google sign in error:', error);
                showError(error.message || 'Google sign in failed');
                document.getElementById('loader').style.display = 'none';
            }
        }

        async function handleSuccessfulAuth() {
            try {
                const user = await getCurrentUser();
                const session = await fetchAuthSession();
                const userId = session.tokens?.idToken?.payload?.sub || user.userId;

                currentUser = {
                    uid: userId,
                    email: session.tokens?.idToken?.payload?.email || user.username,
                    username: user.username,
                    name: session.tokens?.idToken?.payload?.name,
                    givenName: session.tokens?.idToken?.payload?.given_name
                };

                // Check if this is a first-time user
                if (!hasUserProfile(currentUser.uid)) {
                    showProfileSetup(currentUser);
                } else {
                    window.location.href = 'dashboard.html';
                }
            } catch (error) {
                console.error('Error getting user:', error);
                showError('Authentication error');
            }
        }

        // Profile form submission
        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!currentUser) {
                try {
                    const user = await getCurrentUser();
                    const session = await fetchAuthSession();
                    currentUser = {
                        uid: session.tokens?.idToken?.payload?.sub || user.userId,
                        email: session.tokens?.idToken?.payload?.email || user.username,
                        username: user.username,
                        name: session.tokens?.idToken?.payload?.name,
                        givenName: session.tokens?.idToken?.payload?.given_name
                    };
                } catch (error) {
                    showError('Please sign in first');
                    return;
                }
            }

            // Collect form data
            const profileData = {
                displayName: document.getElementById('displayName').value,
                age: document.getElementById('age').value,
                journalGoal: document.getElementById('journalGoal').value,
                writingFrequency: document.getElementById('writingFrequency').value,
                favoriteTime: document.getElementById('favoriteTime').value,
                inspiration: document.getElementById('inspiration').value,
                createdAt: new Date().toISOString(),
                uid: currentUser.uid,
                email: currentUser.email
            };

            // Save profile
            saveUserProfile(currentUser.uid, profileData);

            // Show success message and redirect
            showSuccessMessage(() => {
                window.location.href = 'dashboard.html';
            });
        });

        // Skip profile setup
        async function skipProfile() {
            if (!currentUser) {
                try {
                    const user = await getCurrentUser();
                    const session = await fetchAuthSession();
                    currentUser = {
                        uid: session.tokens?.idToken?.payload?.sub || user.userId,
                        email: session.tokens?.idToken?.payload?.email || user.username,
                        username: user.username,
                        name: session.tokens?.idToken?.payload?.name,
                        givenName: session.tokens?.idToken?.payload?.given_name
                    };
                } catch (error) {
                    showError('Please sign in first');
                    return;
                }
            }

            // Save minimal profile - use Google name if available
            const profileData = {
                displayName: currentUser.name || currentUser.givenName || currentUser.email?.split('@')[0] || 'User',
                age: '',
                journalGoal: '',
                writingFrequency: '',
                favoriteTime: '',
                inspiration: '',
                createdAt: new Date().toISOString(),
                uid: currentUser.uid,
                email: currentUser.email,
                skipped: true
            };

            saveUserProfile(currentUser.uid, profileData);
            window.location.href = 'dashboard.html';
        }

        // Success message
        function showSuccessMessage(callback) {
            const profileSetup = document.getElementById('profileSetup');
            profileSetup.innerHTML = `
                <div class="success-message">
                    <div class="success-icon">âœ“</div>
                    <h2>Welcome to Day by Day!</h2>
                    <p>Your profile has been created successfully.</p>
                    <p>Let's start your journaling journey...</p>
                </div>
            `;

            setTimeout(callback, 2000);
        }

        // Check authentication state on page load
        async function checkAuthState() {
            try {
                const user = await getCurrentUser();
                const session = await fetchAuthSession();
                const userId = session.tokens?.idToken?.payload?.sub || user.userId;

                currentUser = {
                    uid: userId,
                    email: session.tokens?.idToken?.payload?.email || user.username,
                    username: user.username,
                    name: session.tokens?.idToken?.payload?.name,
                    givenName: session.tokens?.idToken?.payload?.given_name
                };

                // User is signed in
                if (hasUserProfile(currentUser.uid)) {
                    // Existing user - redirect to dashboard
                    window.location.href = 'dashboard.html';
                } else {
                    // New user - show profile setup
                    showProfileSetup(currentUser);
                }
            } catch (error) {
                // Not signed in - show sign in form directly
                console.log('Not authenticated:', error.message);
                showSignIn();
            }
        }

        async function signOutUser() {
            try {
                await signOut();
                currentUser = null;
                showSignIn();
            } catch (error) {
                console.error('Sign out error:', error);
            }
        }

        // Initialize on page load
        setupCodeInputs();
        checkAuthState();

        // Expose functions to window for onclick handlers (ES modules have their own scope)
        window.showSignIn = showSignIn;
        window.showSignInForm = showSignInForm;
        window.showSignUpForm = showSignUpForm;
        window.signInWithEmail = signInWithEmail;
        window.signUpWithEmail = signUpWithEmail;
        window.handleConfirmSignUp = handleConfirmSignUp;
        window.resendCode = resendCode;
        window.signInWithGoogle = signInWithGoogle;
        window.skipProfile = skipProfile;
    </script>

</body>
</html>
