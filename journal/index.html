<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Day by Day - Your Personal Journal</title>
    <!-- Google Fonts for better typography -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- External CSS -->
    <link rel="stylesheet" href="styles.css">

    <!-- AWS Amplify for Cognito Authentication (loaded as ES module) -->

</head>
<body>
    <!-- Welcome Screen (hidden - users go directly to login) -->
    <div class="container" id="welcomeScreen" style="display: none;">
        <h1>Day by Day</h1>
        <p class="subtitle">Your personal space for reflection and growth</p>
        <div class="buttons">
            <button id="signInBtn" onclick="showSignIn()">Get Started</button>
        </div>
    </div>

    <!-- Loading Screen (shown while module loads) -->
    <div class="container" id="loadingScreen">
        <h2>Day by Day</h2>
        <p class="subtitle">Loading...</p>
        <div class="spinner"></div>
    </div>

    <!-- Sign In Container -->
    <div class="container" id="signInContainer" style="display: none;">
        <h2>Welcome Back</h2>
        <p class="subtitle">Sign in to continue your journey</p>

        <!-- Auth Forms Container -->
        <div id="authFormsContainer">
            <!-- Sign In Form -->
            <div id="signInForm" class="auth-form">
                <div class="form-group">
                    <input type="email" id="signInEmail" placeholder="Email" required>
                </div>
                <div class="form-group">
                    <input type="password" id="signInPassword" placeholder="Password" required>
                </div>
                <button type="button" class="primary-btn" onclick="signInWithEmail()">Sign In</button>
                <p class="auth-switch">Don't have an account? <a href="#" onclick="showSignUpForm()">Sign Up</a></p>
            </div>

            <!-- Sign Up Form (hidden by default) -->
            <div id="signUpForm" class="auth-form" style="display: none;">
                <div class="form-group">
                    <input type="email" id="signUpEmail" placeholder="Email" required>
                </div>
                <div class="form-group">
                    <input type="password" id="signUpPassword" placeholder="Password (min 8 chars)" required minlength="8">
                </div>
                <div class="form-group">
                    <input type="password" id="signUpPasswordConfirm" placeholder="Confirm Password" required>
                </div>
                <button type="button" class="primary-btn" onclick="signUpWithEmail()">Create Account</button>
                <p class="auth-switch">Already have an account? <a href="#" onclick="showSignInForm()">Sign In</a></p>
            </div>

            <!-- Verification Form (hidden by default) -->
            <div id="verificationForm" class="auth-form" style="display: none;">
                <div class="verification-header">
                    <div class="verification-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 8L10.89 13.26C11.2187 13.4793 11.6049 13.5963 12 13.5963C12.3951 13.5963 12.7813 13.4793 13.11 13.26L21 8M5 19H19C19.5304 19 20.0391 18.7893 20.4142 18.4142C20.7893 18.0391 21 17.5304 21 17V7C21 6.46957 20.7893 5.96086 20.4142 5.58579C20.0391 5.21071 19.5304 5 19 5H5C4.46957 5 3.96086 5.21071 3.58579 5.58579C3.21071 5.96086 3 6.46957 3 7V17C3 17.5304 3.21071 18.0391 3.58579 18.4142C3.96086 18.7893 4.46957 19 5 19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <h3>Check your email</h3>
                    <p class="verification-email">We sent a code to <strong id="verificationEmailDisplay"></strong></p>
                </div>
                <div class="code-input-container">
                    <input type="text" maxlength="1" class="code-digit" data-index="0" inputmode="numeric" pattern="[0-9]" autocomplete="one-time-code">
                    <input type="text" maxlength="1" class="code-digit" data-index="1" inputmode="numeric" pattern="[0-9]">
                    <input type="text" maxlength="1" class="code-digit" data-index="2" inputmode="numeric" pattern="[0-9]">
                    <input type="text" maxlength="1" class="code-digit" data-index="3" inputmode="numeric" pattern="[0-9]">
                    <input type="text" maxlength="1" class="code-digit" data-index="4" inputmode="numeric" pattern="[0-9]">
                    <input type="text" maxlength="1" class="code-digit" data-index="5" inputmode="numeric" pattern="[0-9]">
                </div>
                <input type="hidden" id="verificationCode">
                <button type="button" class="primary-btn" id="verifyBtn" onclick="handleConfirmSignUp()" disabled>Verify Email</button>
                <div class="resend-section">
                    <p id="resendText">Didn't receive the code? <a href="#" id="resendLink" onclick="resendCode()">Resend</a></p>
                    <p id="resendTimer" style="display: none;">Resend code in <span id="timerCount">60</span>s</p>
                </div>
            </div>

            <!-- Verification Success (hidden by default) -->
            <div id="verificationSuccess" class="auth-form" style="display: none;">
                <div class="verification-success">
                    <div class="success-checkmark">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="10" stroke="#4CAF50" stroke-width="2"/>
                            <path d="M8 12L11 15L16 9" stroke="#4CAF50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <h3>Email Verified!</h3>
                    <p>Your account has been verified successfully.</p>
                    <p class="redirect-text">Redirecting to sign in...</p>
                </div>
            </div>

            <!-- Divider -->
            <div class="auth-divider">
                <span>or</span>
            </div>

            <!-- Google Sign In -->
            <button type="button" class="google-btn" onclick="signInWithGoogle()">
                <svg width="18" height="18" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg">
                    <path d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z" fill="#4285F4"/>
                    <path d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z" fill="#34A853"/>
                    <path d="M3.964 10.71c-.18-.54-.282-1.117-.282-1.71s.102-1.17.282-1.71V4.958H.957C.347 6.173 0 7.548 0 9s.348 2.827.957 4.042l3.007-2.332z" fill="#FBBC05"/>
                    <path d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z" fill="#EA4335"/>
                </svg>
                Continue with Google
            </button>
        </div>

        <div id="loader" style="display:none;">
            <div class="spinner"></div>
            <p>Setting up your journal...</p>
        </div>
        <div id="authError" class="auth-error" style="display: none;"></div>
        <div class="auth-note">
            <p>Sign in with your email or Google account</p>
        </div>
    </div>

    <!-- Profile Setup for First-Time Users - Apple-style Multi-step Wizard -->
    <div class="onboarding-container" id="profileSetup" style="display: none;">
        <!-- Progress Indicator -->
        <div class="progress-dots">
            <div class="dot active" data-step="1"></div>
            <div class="dot" data-step="2"></div>
            <div class="dot" data-step="3"></div>
            <div class="dot" data-step="4"></div>
        </div>

        <!-- Step 1: Welcome & Name -->
        <div class="onboarding-step active" data-step="1">
            <div class="step-icon">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z" fill="currentColor"/>
                </svg>
            </div>
            <h1 class="step-title">Let's get to know you</h1>
            <p class="step-subtitle">Help us personalize your journaling experience</p>

            <div class="input-group">
                <label for="displayName">What should we call you?</label>
                <input type="text" id="displayName" placeholder="Your name" autocomplete="name" autofocus>
            </div>

            <div class="step-actions">
                <button type="button" class="continue-btn" onclick="nextStep(1)" id="step1Continue" disabled>Continue</button>
            </div>
            <button type="button" class="skip-link" onclick="skipProfile()">Set up later</button>
        </div>

        <!-- Step 2: Journaling Goal -->
        <div class="onboarding-step" data-step="2">
            <div class="step-icon">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none">
                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z" fill="currentColor"/>
                </svg>
            </div>
            <h1 class="step-title">What brings you here?</h1>
            <p class="step-subtitle">Choose what resonates with you most</p>

            <div class="selection-cards" id="goalCards">
                <button type="button" class="selection-card" data-value="self-reflection">
                    <span class="card-icon">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                            <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </span>
                    <span class="card-label">Mindfulness</span>
                    <span class="card-desc">Self-reflection & presence</span>
                </button>
                <button type="button" class="selection-card" data-value="emotional-wellness">
                    <span class="card-icon">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
                            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" fill="currentColor"/>
                        </svg>
                    </span>
                    <span class="card-label">Wellness</span>
                    <span class="card-desc">Emotional balance & relief</span>
                </button>
                <button type="button" class="selection-card" data-value="goal-tracking">
                    <span class="card-icon">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14l-5-5 1.41-1.41L12 14.17l6.59-6.59L20 9l-8 8z" fill="currentColor"/>
                        </svg>
                    </span>
                    <span class="card-label">Goals</span>
                    <span class="card-desc">Tracking & productivity</span>
                </button>
                <button type="button" class="selection-card" data-value="creative-expression">
                    <span class="card-icon">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
                            <path d="M7 14c-1.66 0-3 1.34-3 3 0 1.31-1.16 2-2 2 .92 1.22 2.49 2 4 2 2.21 0 4-1.79 4-4 0-1.66-1.34-3-3-3zm13.71-9.37l-1.34-1.34a.996.996 0 00-1.41 0L9 12.25 11.75 15l8.96-8.96a.996.996 0 000-1.41z" fill="currentColor"/>
                        </svg>
                    </span>
                    <span class="card-label">Creativity</span>
                    <span class="card-desc">Expression & writing</span>
                </button>
                <button type="button" class="selection-card" data-value="memory-keeping">
                    <span class="card-icon">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
                            <path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z" fill="currentColor"/>
                        </svg>
                    </span>
                    <span class="card-label">Memories</span>
                    <span class="card-desc">Life documentation</span>
                </button>
                <button type="button" class="selection-card" data-value="habit-building">
                    <span class="card-icon">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
                            <path d="M13 2.05v2.02c3.95.49 7 3.85 7 7.93 0 3.21-1.92 6-4.72 7.28L13 17v5h5l-1.22-1.22C19.91 19.07 22 15.76 22 12c0-5.18-3.95-9.45-9-9.95zM11 2.05C5.94 2.55 2 6.81 2 12c0 3.76 2.09 7.07 5.16 8.78L6 22h5v-5l-2.28 2.28C6.92 18 5 15.21 5 12c0-4.08 3.05-7.44 7-7.93V2.05z" fill="currentColor"/>
                        </svg>
                    </span>
                    <span class="card-label">Growth</span>
                    <span class="card-desc">Habits & development</span>
                </button>
            </div>

            <input type="hidden" id="journalGoal" value="">

            <div class="step-actions">
                <button type="button" class="back-btn" onclick="prevStep(2)">Back</button>
                <button type="button" class="continue-btn" onclick="nextStep(2)" id="step2Continue" disabled>Continue</button>
            </div>
        </div>

        <!-- Step 3: Writing Frequency -->
        <div class="onboarding-step" data-step="3">
            <div class="step-icon">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none">
                    <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11zM9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm-8 4H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z" fill="currentColor"/>
                </svg>
            </div>
            <h1 class="step-title">How often will you write?</h1>
            <p class="step-subtitle">There's no wrong answer - just what feels right</p>

            <div class="selection-list" id="frequencyList">
                <button type="button" class="selection-item" data-value="daily">
                    <span class="item-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </span>
                    <span class="item-content">
                        <span class="item-label">Every day</span>
                        <span class="item-desc">Build a daily habit</span>
                    </span>
                    <span class="item-check">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z" fill="currentColor"/>
                        </svg>
                    </span>
                </button>
                <button type="button" class="selection-item" data-value="few-times-week">
                    <span class="item-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </span>
                    <span class="item-content">
                        <span class="item-label">A few times a week</span>
                        <span class="item-desc">Regular check-ins</span>
                    </span>
                    <span class="item-check">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z" fill="currentColor"/>
                        </svg>
                    </span>
                </button>
                <button type="button" class="selection-item" data-value="weekly">
                    <span class="item-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </span>
                    <span class="item-content">
                        <span class="item-label">Once a week</span>
                        <span class="item-desc">Weekly reflection</span>
                    </span>
                    <span class="item-check">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z" fill="currentColor"/>
                        </svg>
                    </span>
                </button>
                <button type="button" class="selection-item" data-value="when-inspired">
                    <span class="item-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </span>
                    <span class="item-content">
                        <span class="item-label">When inspiration strikes</span>
                        <span class="item-desc">No pressure, just flow</span>
                    </span>
                    <span class="item-check">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z" fill="currentColor"/>
                        </svg>
                    </span>
                </button>
            </div>

            <input type="hidden" id="writingFrequency" value="">

            <div class="step-actions">
                <button type="button" class="back-btn" onclick="prevStep(3)">Back</button>
                <button type="button" class="continue-btn" onclick="nextStep(3)" id="step3Continue" disabled>Continue</button>
            </div>
        </div>

        <!-- Step 4: Preferred Time -->
        <div class="onboarding-step" data-step="4">
            <div class="step-icon">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none">
                    <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67V7z" fill="currentColor"/>
                </svg>
            </div>
            <h1 class="step-title">When do you write best?</h1>
            <p class="step-subtitle">We'll personalize your experience</p>

            <div class="time-cards" id="timeCards">
                <button type="button" class="time-card" data-value="morning">
                    <span class="time-icon">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
                            <circle cx="12" cy="12" r="4" fill="currentColor"/>
                            <path d="M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </span>
                    <span class="time-label">Morning</span>
                    <span class="time-range">6AM - 12PM</span>
                </button>
                <button type="button" class="time-card" data-value="afternoon">
                    <span class="time-icon">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
                            <circle cx="12" cy="12" r="5" fill="currentColor"/>
                            <path d="M12 3v2M12 19v2M5.64 5.64l1.41 1.41M16.95 16.95l1.41 1.41M3 12h2M19 12h2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </span>
                    <span class="time-label">Afternoon</span>
                    <span class="time-range">12PM - 6PM</span>
                </button>
                <button type="button" class="time-card" data-value="evening">
                    <span class="time-icon">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
                            <path d="M12 3C7.03 3 3 7.03 3 12s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8z" fill="currentColor"/>
                        </svg>
                    </span>
                    <span class="time-label">Evening</span>
                    <span class="time-range">6PM - 10PM</span>
                </button>
                <button type="button" class="time-card" data-value="night">
                    <span class="time-icon">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
                            <path d="M12 3a9 9 0 109 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 01-4.4 2.26 5.403 5.403 0 01-3.14-9.8c-.44-.06-.9-.1-1.36-.1z" fill="currentColor"/>
                        </svg>
                    </span>
                    <span class="time-label">Night</span>
                    <span class="time-range">10PM - 6AM</span>
                </button>
            </div>

            <input type="hidden" id="favoriteTime" value="">
            <input type="hidden" id="age" value="">
            <input type="hidden" id="inspiration" value="">

            <div class="step-actions">
                <button type="button" class="back-btn" onclick="prevStep(4)">Back</button>
                <button type="button" class="continue-btn finish-btn" onclick="completeOnboarding()" id="step4Continue">Get Started</button>
            </div>
        </div>

        <!-- Completion Screen -->
        <div class="onboarding-step completion-step" data-step="complete">
            <div class="completion-animation">
                <div class="completion-circle">
                    <svg width="80" height="80" viewBox="0 0 24 24" fill="none">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z" fill="currentColor" class="check-path"/>
                    </svg>
                </div>
            </div>
            <h1 class="step-title completion-title">You're all set, <span id="completionName">friend</span>!</h1>
            <p class="step-subtitle">Your journal is ready. Let's begin your journey.</p>
            <div class="completion-loader">
                <div class="loader-bar"></div>
            </div>
        </div>
    </div>

    <!-- Placeholder functions while module loads -->
    <script>
        // These will be replaced by the module once it loads
        window.signInWithEmail = window.signUpWithEmail = window.signInWithGoogle =
        window.handleConfirmSignUp = window.resendCode = window.skipProfile =
        window.showSignIn = window.showSignInForm = window.showSignUpForm =
        window.nextStep = window.prevStep = window.completeOnboarding = function() {
            console.log('Please wait, loading...');
        };
    </script>

    <!-- Cognito Auth and Application Logic -->
    <script type="module">
        // Import AWS Amplify v6 from esm.sh CDN
        import { Amplify } from 'https://esm.sh/aws-amplify@6';
        import { signIn, signUp, confirmSignUp, resendSignUpCode, signOut, getCurrentUser, fetchAuthSession, signInWithRedirect } from 'https://esm.sh/aws-amplify@6/auth';

        // Cognito Configuration
        const cognitoConfig = {
            userPoolId: 'us-west-1_81HBZnH92',
            userPoolClientId: '7t77oqaipn9hldtdpesvde3eka',
            region: 'us-west-1',
            domain: 'daybyday-journal.auth.us-west-1.amazoncognito.com'
        };

        // Determine the correct redirect URL based on current environment
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const currentOrigin = window.location.origin;
        const redirectSignIn = isLocalhost
            ? 'http://localhost/journal/dashboard.html'
            : `${currentOrigin}/journal/dashboard.html`;
        const redirectSignOut = isLocalhost
            ? 'http://localhost/journal/index.html'
            : `${currentOrigin}/journal/index.html`;

        Amplify.configure({
            Auth: {
                Cognito: {
                    userPoolId: cognitoConfig.userPoolId,
                    userPoolClientId: cognitoConfig.userPoolClientId,
                    loginWith: {
                        oauth: {
                            domain: cognitoConfig.domain,
                            scopes: ['openid', 'email', 'profile'],
                            redirectSignIn: [redirectSignIn],
                            redirectSignOut: [redirectSignOut],
                            responseType: 'code',
                            providers: ['Google']
                        }
                    }
                }
            }
        });

        // Current user state
        let currentUser = null;
        let pendingEmail = null;

        // Preserve invite token in sessionStorage during auth flow
        function preserveInviteToken() {
            const urlParams = new URLSearchParams(window.location.search);
            const inviteToken = urlParams.get('invite');
            if (inviteToken) {
                sessionStorage.setItem('pendingInviteToken', inviteToken);
            }
        }
        preserveInviteToken();

        // Get redirect URL based on pending invite
        function getRedirectUrl() {
            const pendingInvite = sessionStorage.getItem('pendingInviteToken');
            return pendingInvite
                ? `connections.html?invite=${pendingInvite}`
                : 'dashboard.html';
        }

        // Check if user profile exists
        function hasUserProfile(uid) {
            return localStorage.getItem(`user_profile_${uid}`) !== null;
        }

        // Save user profile
        function saveUserProfile(uid, profileData) {
            localStorage.setItem(`user_profile_${uid}`, JSON.stringify(profileData));
        }

        // Get user profile
        function getUserProfile(uid) {
            const profile = localStorage.getItem(`user_profile_${uid}`);
            return profile ? JSON.parse(profile) : null;
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // Navigation functions
        function showSignIn() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('signInContainer').style.display = 'block';
            document.getElementById('profileSetup').style.display = 'none';
            showSignInForm();
        }

        function showSignInForm() {
            document.getElementById('signInForm').style.display = 'block';
            document.getElementById('signUpForm').style.display = 'none';
            document.getElementById('verificationForm').style.display = 'none';
        }

        function showSignUpForm() {
            document.getElementById('signInForm').style.display = 'none';
            document.getElementById('signUpForm').style.display = 'block';
            document.getElementById('verificationForm').style.display = 'none';
        }

        function showVerificationForm() {
            document.getElementById('signInForm').style.display = 'none';
            document.getElementById('signUpForm').style.display = 'none';
            document.getElementById('verificationForm').style.display = 'block';
            document.getElementById('verificationSuccess').style.display = 'none';

            // Display the email the code was sent to
            if (pendingEmail) {
                document.getElementById('verificationEmailDisplay').textContent = pendingEmail;
            }

            // Clear and focus first input
            const codeInputs = document.querySelectorAll('.code-digit');
            codeInputs.forEach(input => input.value = '');
            codeInputs[0].focus();
            document.getElementById('verifyBtn').disabled = true;

            // Reset resend timer display
            document.getElementById('resendText').style.display = 'block';
            document.getElementById('resendTimer').style.display = 'none';
        }

        // Setup code input handlers
        function setupCodeInputs() {
            const codeInputs = document.querySelectorAll('.code-digit');

            codeInputs.forEach((input, index) => {
                // Handle input
                input.addEventListener('input', (e) => {
                    const value = e.target.value;

                    // Only allow numbers
                    if (!/^\d*$/.test(value)) {
                        e.target.value = '';
                        return;
                    }

                    // Auto-advance to next input
                    if (value && index < 5) {
                        codeInputs[index + 1].focus();
                    }

                    // Update hidden input and check if complete
                    updateVerificationCode();
                });

                // Handle backspace
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        codeInputs[index - 1].focus();
                    }
                });

                // Handle paste
                input.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const pastedData = e.clipboardData.getData('text').replace(/\D/g, '').slice(0, 6);

                    pastedData.split('').forEach((char, i) => {
                        if (codeInputs[i]) {
                            codeInputs[i].value = char;
                        }
                    });

                    // Focus appropriate input
                    const nextIndex = Math.min(pastedData.length, 5);
                    codeInputs[nextIndex].focus();

                    updateVerificationCode();
                });
            });
        }

        function updateVerificationCode() {
            const codeInputs = document.querySelectorAll('.code-digit');
            const code = Array.from(codeInputs).map(input => input.value).join('');
            document.getElementById('verificationCode').value = code;

            // Enable/disable verify button
            const verifyBtn = document.getElementById('verifyBtn');
            verifyBtn.disabled = code.length !== 6;

            // Auto-submit when complete
            if (code.length === 6) {
                handleConfirmSignUp();
            }
        }

        let resendTimerId = null;

        function startResendTimer() {
            document.getElementById('resendText').style.display = 'none';
            document.getElementById('resendTimer').style.display = 'block';

            let seconds = 60;
            document.getElementById('timerCount').textContent = seconds;

            if (resendTimerId) clearInterval(resendTimerId);

            resendTimerId = setInterval(() => {
                seconds--;
                document.getElementById('timerCount').textContent = seconds;

                if (seconds <= 0) {
                    clearInterval(resendTimerId);
                    document.getElementById('resendText').style.display = 'block';
                    document.getElementById('resendTimer').style.display = 'none';
                }
            }, 1000);
        }

        function showVerificationSuccess() {
            document.getElementById('verificationForm').style.display = 'none';
            document.getElementById('verificationSuccess').style.display = 'block';

            // Redirect to sign in after animation
            setTimeout(() => {
                showSignInForm();
                document.getElementById('verificationSuccess').style.display = 'none';
                if (pendingEmail) {
                    document.getElementById('signInEmail').value = pendingEmail;
                }
            }, 2000);
        }

        function showProfileSetup(user) {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('signInContainer').style.display = 'none';
            document.getElementById('profileSetup').style.display = 'flex';

            // Pre-fill display name: prioritize Google name > given_name > email prefix
            const displayName = user.name ||
                               user.givenName ||
                               (user.email?.split('@')[0]) ||
                               (user.username?.includes('@') ? user.username.split('@')[0] : user.username) ||
                               '';
            document.getElementById('displayName').value = displayName;

            // Initialize wizard
            initializeOnboardingWizard();

            // Enable continue if name is pre-filled
            if (displayName) {
                document.getElementById('step1Continue').disabled = false;
            }
        }

        // Onboarding Wizard Functions
        let currentStep = 1;

        function initializeOnboardingWizard() {
            // Name input validation
            const nameInput = document.getElementById('displayName');
            nameInput.addEventListener('input', () => {
                document.getElementById('step1Continue').disabled = !nameInput.value.trim();
            });

            // Goal cards
            document.querySelectorAll('#goalCards .selection-card').forEach(card => {
                card.addEventListener('click', () => {
                    document.querySelectorAll('#goalCards .selection-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    document.getElementById('journalGoal').value = card.dataset.value;
                    document.getElementById('step2Continue').disabled = false;
                });
            });

            // Frequency list
            document.querySelectorAll('#frequencyList .selection-item').forEach(item => {
                item.addEventListener('click', () => {
                    document.querySelectorAll('#frequencyList .selection-item').forEach(i => i.classList.remove('selected'));
                    item.classList.add('selected');
                    document.getElementById('writingFrequency').value = item.dataset.value;
                    document.getElementById('step3Continue').disabled = false;
                });
            });

            // Time cards
            document.querySelectorAll('#timeCards .time-card').forEach(card => {
                card.addEventListener('click', () => {
                    document.querySelectorAll('#timeCards .time-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    document.getElementById('favoriteTime').value = card.dataset.value;
                });
            });

            // Focus on name input
            setTimeout(() => nameInput.focus(), 100);
        }

        function nextStep(fromStep) {
            const currentStepEl = document.querySelector(`.onboarding-step[data-step="${fromStep}"]`);
            const nextStepEl = document.querySelector(`.onboarding-step[data-step="${fromStep + 1}"]`);

            if (!nextStepEl) return;

            // Animate out
            currentStepEl.classList.add('slide-out-left');

            setTimeout(() => {
                currentStepEl.classList.remove('active', 'slide-out-left');
                nextStepEl.classList.add('active', 'slide-in-right');

                // Update progress dots
                document.querySelectorAll('.progress-dots .dot').forEach(dot => {
                    const dotStep = parseInt(dot.dataset.step);
                    dot.classList.toggle('active', dotStep === fromStep + 1);
                    dot.classList.toggle('completed', dotStep < fromStep + 1);
                });

                setTimeout(() => {
                    nextStepEl.classList.remove('slide-in-right');
                }, 400);

                currentStep = fromStep + 1;
            }, 300);
        }

        function prevStep(fromStep) {
            const currentStepEl = document.querySelector(`.onboarding-step[data-step="${fromStep}"]`);
            const prevStepEl = document.querySelector(`.onboarding-step[data-step="${fromStep - 1}"]`);

            if (!prevStepEl) return;

            // Animate out
            currentStepEl.classList.add('slide-out-right');

            setTimeout(() => {
                currentStepEl.classList.remove('active', 'slide-out-right');
                prevStepEl.classList.add('active', 'slide-in-left');

                // Update progress dots
                document.querySelectorAll('.progress-dots .dot').forEach(dot => {
                    const dotStep = parseInt(dot.dataset.step);
                    dot.classList.toggle('active', dotStep === fromStep - 1);
                    dot.classList.toggle('completed', dotStep < fromStep - 1);
                });

                setTimeout(() => {
                    prevStepEl.classList.remove('slide-in-left');
                }, 400);

                currentStep = fromStep - 1;
            }, 300);
        }

        async function completeOnboarding() {
            if (!currentUser) {
                try {
                    const user = await getCurrentUser();
                    const session = await fetchAuthSession();
                    currentUser = {
                        uid: session.tokens?.idToken?.payload?.sub || user.userId,
                        email: session.tokens?.idToken?.payload?.email || user.username,
                        username: user.username,
                        name: session.tokens?.idToken?.payload?.name,
                        givenName: session.tokens?.idToken?.payload?.given_name
                    };
                } catch (error) {
                    showError('Please sign in first');
                    return;
                }
            }

            // Collect form data
            const displayName = document.getElementById('displayName').value;
            const profileData = {
                displayName: displayName,
                age: document.getElementById('age').value,
                journalGoal: document.getElementById('journalGoal').value,
                writingFrequency: document.getElementById('writingFrequency').value,
                favoriteTime: document.getElementById('favoriteTime').value,
                inspiration: document.getElementById('inspiration').value,
                createdAt: new Date().toISOString(),
                uid: currentUser.uid,
                email: currentUser.email
            };

            // Save profile
            saveUserProfile(currentUser.uid, profileData);

            // Show completion screen
            const step4 = document.querySelector('.onboarding-step[data-step="4"]');
            const completionStep = document.querySelector('.onboarding-step[data-step="complete"]');

            document.getElementById('completionName').textContent = displayName.split(' ')[0] || 'friend';

            step4.classList.add('slide-out-left');

            setTimeout(() => {
                step4.classList.remove('active', 'slide-out-left');
                completionStep.classList.add('active');

                // Hide progress dots
                document.querySelector('.progress-dots').style.opacity = '0';

                // Redirect after animation
                setTimeout(() => {
                    window.location.href = getRedirectUrl();
                }, 2500);
            }, 300);
        }

        // Auth functions
        async function signInWithEmail() {
            const email = document.getElementById('signInEmail').value;
            const password = document.getElementById('signInPassword').value;

            if (!email || !password) {
                showError('Please enter email and password');
                return;
            }

            try {
                document.getElementById('loader').style.display = 'block';
                const result = await signIn({ username: email, password });

                // Amplify v6 returns nextStep instead of isSignedIn
                if (result.isSignedIn || result.nextStep?.signInStep === 'DONE') {
                    await handleSuccessfulAuth();
                }
            } catch (error) {
                console.error('Sign in error:', error);
                if (error.name === 'UserNotConfirmedException') {
                    pendingEmail = email;
                    showVerificationForm();
                    showError('Please verify your email first');
                } else {
                    showError(error.message || 'Sign in failed');
                }
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        async function signUpWithEmail() {
            const email = document.getElementById('signUpEmail').value;
            const password = document.getElementById('signUpPassword').value;
            const confirmPassword = document.getElementById('signUpPasswordConfirm').value;

            if (!email || !password) {
                showError('Please fill in all fields');
                return;
            }

            if (password !== confirmPassword) {
                showError('Passwords do not match');
                return;
            }

            if (password.length < 8) {
                showError('Password must be at least 8 characters');
                return;
            }

            try {
                document.getElementById('loader').style.display = 'block';
                const result = await signUp({
                    username: email,
                    password,
                    options: {
                        userAttributes: {
                            email
                        }
                    }
                });

                pendingEmail = email;

                if (result.nextStep.signUpStep === 'CONFIRM_SIGN_UP') {
                    showVerificationForm();
                }
            } catch (error) {
                console.error('Sign up error:', error);
                showError(error.message || 'Sign up failed');
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        async function handleConfirmSignUp() {
            const code = document.getElementById('verificationCode').value;

            if (!code || code.length !== 6 || !pendingEmail) {
                showError('Please enter the 6-digit verification code');
                return;
            }

            try {
                document.getElementById('verifyBtn').disabled = true;
                document.getElementById('verifyBtn').textContent = 'Verifying...';

                await confirmSignUp({
                    username: pendingEmail,
                    confirmationCode: code
                });

                // Show success animation then redirect
                showVerificationSuccess();
            } catch (error) {
                console.error('Confirmation error:', error);

                // Clear inputs on error
                const codeInputs = document.querySelectorAll('.code-digit');
                codeInputs.forEach(input => input.value = '');
                codeInputs[0].focus();
                document.getElementById('verificationCode').value = '';

                // Show specific error messages
                if (error.name === 'CodeMismatchException') {
                    showError('Invalid code. Please check and try again.');
                } else if (error.name === 'ExpiredCodeException') {
                    showError('Code expired. Please request a new one.');
                } else {
                    showError(error.message || 'Verification failed');
                }
            } finally {
                document.getElementById('verifyBtn').disabled = false;
                document.getElementById('verifyBtn').textContent = 'Verify Email';
            }
        }

        async function resendCode() {
            if (!pendingEmail) {
                showError('Please enter your email first');
                return;
            }

            try {
                await resendSignUpCode({ username: pendingEmail });

                // Start cooldown timer
                startResendTimer();

                // Clear existing code inputs
                const codeInputs = document.querySelectorAll('.code-digit');
                codeInputs.forEach(input => input.value = '');
                codeInputs[0].focus();
                document.getElementById('verificationCode').value = '';
                document.getElementById('verifyBtn').disabled = true;

            } catch (error) {
                console.error('Resend error:', error);
                showError(error.message || 'Failed to resend code');
            }
        }

        async function signInWithGoogle() {
            try {
                document.getElementById('loader').style.display = 'block';
                await signInWithRedirect({ provider: 'Google' });
            } catch (error) {
                console.error('Google sign in error:', error);
                showError(error.message || 'Google sign in failed');
                document.getElementById('loader').style.display = 'none';
            }
        }

        async function handleSuccessfulAuth() {
            try {
                const user = await getCurrentUser();
                const session = await fetchAuthSession();
                const userId = session.tokens?.idToken?.payload?.sub || user.userId;

                currentUser = {
                    uid: userId,
                    email: session.tokens?.idToken?.payload?.email || user.username,
                    username: user.username,
                    name: session.tokens?.idToken?.payload?.name,
                    givenName: session.tokens?.idToken?.payload?.given_name
                };

                // Check if this is a first-time user
                if (!hasUserProfile(currentUser.uid)) {
                    showProfileSetup(currentUser);
                } else {
                    window.location.href = getRedirectUrl();
                }
            } catch (error) {
                console.error('Error getting user:', error);
                showError('Authentication error');
            }
        }

        // Skip profile setup
        async function skipProfile() {
            if (!currentUser) {
                try {
                    const user = await getCurrentUser();
                    const session = await fetchAuthSession();
                    currentUser = {
                        uid: session.tokens?.idToken?.payload?.sub || user.userId,
                        email: session.tokens?.idToken?.payload?.email || user.username,
                        username: user.username,
                        name: session.tokens?.idToken?.payload?.name,
                        givenName: session.tokens?.idToken?.payload?.given_name
                    };
                } catch (error) {
                    showError('Please sign in first');
                    return;
                }
            }

            // Save minimal profile - use Google name if available
            const profileData = {
                displayName: currentUser.name || currentUser.givenName || currentUser.email?.split('@')[0] || 'User',
                age: '',
                journalGoal: '',
                writingFrequency: '',
                favoriteTime: '',
                inspiration: '',
                createdAt: new Date().toISOString(),
                uid: currentUser.uid,
                email: currentUser.email,
                skipped: true
            };

            saveUserProfile(currentUser.uid, profileData);
            window.location.href = getRedirectUrl();
        }

        // Success message
        function showSuccessMessage(callback) {
            const profileSetup = document.getElementById('profileSetup');
            profileSetup.innerHTML = `
                <div class="success-message">
                    <div class="success-icon"></div>
                    <h2>Welcome to Day by Day!</h2>
                    <p>Your profile has been created successfully.</p>
                    <p>Let's start your journaling journey...</p>
                </div>
            `;

            setTimeout(callback, 2000);
        }

        // Check authentication state on page load
        async function checkAuthState() {
            try {
                const user = await getCurrentUser();
                const session = await fetchAuthSession();
                const userId = session.tokens?.idToken?.payload?.sub || user.userId;

                currentUser = {
                    uid: userId,
                    email: session.tokens?.idToken?.payload?.email || user.username,
                    username: user.username,
                    name: session.tokens?.idToken?.payload?.name,
                    givenName: session.tokens?.idToken?.payload?.given_name
                };

                // User is signed in
                if (hasUserProfile(currentUser.uid)) {
                    // Existing user - redirect (to connections if invite, else dashboard)
                    window.location.href = getRedirectUrl();
                } else {
                    // New user - show profile setup
                    showProfileSetup(currentUser);
                }
            } catch (error) {
                // Not signed in - show sign in form directly
                console.log('Not authenticated:', error.message);
                showSignIn();
            }
        }

        async function signOutUser() {
            try {
                await signOut();
                currentUser = null;
                showSignIn();
            } catch (error) {
                console.error('Sign out error:', error);
            }
        }

        // Initialize on page load
        setupCodeInputs();
        checkAuthState();

        // Expose functions to window for onclick handlers (ES modules have their own scope)
        window.showSignIn = showSignIn;
        window.showSignInForm = showSignInForm;
        window.showSignUpForm = showSignUpForm;
        window.signInWithEmail = signInWithEmail;
        window.signUpWithEmail = signUpWithEmail;
        window.handleConfirmSignUp = handleConfirmSignUp;
        window.resendCode = resendCode;
        window.signInWithGoogle = signInWithGoogle;
        window.skipProfile = skipProfile;
        window.nextStep = nextStep;
        window.prevStep = prevStep;
        window.completeOnboarding = completeOnboarding;
    </script>

</body>
</html>
