<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Day by Day - Your Personal Journal</title>
    <!-- Google Fonts for better typography -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- External CSS -->
    <link rel="stylesheet" href="styles.css">

    <!-- AWS Amplify for Cognito Authentication (loaded as ES module) -->

</head>
<body>
    <!-- Welcome Screen (hidden - users go directly to login) -->
    <div class="container" id="welcomeScreen" style="display: none;">
        <h1>Day by Day</h1>
        <p class="subtitle">Your personal space for reflection and growth</p>
        <div class="buttons">
            <button id="signInBtn" onclick="showSignIn()">Get Started</button>
        </div>
    </div>

    <!-- Loading Screen (shown while module loads) -->
    <div class="container" id="loadingScreen">
        <h2>Day by Day</h2>
        <p class="subtitle">Loading...</p>
        <div class="spinner"></div>
    </div>

    <!-- Sign In Container -->
    <div class="container" id="signInContainer" style="display: none;">
        <h2>Welcome Back</h2>
        <p class="subtitle">Sign in to continue your journey</p>

        <!-- Auth Forms Container -->
        <div id="authFormsContainer">
            <!-- Sign In Form -->
            <div id="signInForm" class="auth-form">
                <div class="form-group">
                    <input type="email" id="signInEmail" placeholder="Email" required>
                </div>
                <div class="form-group">
                    <input type="password" id="signInPassword" placeholder="Password" required>
                </div>
                <button type="button" class="primary-btn" onclick="signInWithEmail()">Sign In</button>
                <p class="auth-switch">Don't have an account? <a href="#" onclick="showSignUpForm()">Sign Up</a></p>
            </div>

            <!-- Sign Up Form (hidden by default) -->
            <div id="signUpForm" class="auth-form" style="display: none;">
                <div class="form-group">
                    <input type="email" id="signUpEmail" placeholder="Email" required>
                </div>
                <div class="form-group">
                    <input type="password" id="signUpPassword" placeholder="Password (min 8 chars)" required minlength="8">
                </div>
                <div class="form-group">
                    <input type="password" id="signUpPasswordConfirm" placeholder="Confirm Password" required>
                </div>
                <button type="button" class="primary-btn" onclick="signUpWithEmail()">Create Account</button>
                <p class="auth-switch">Already have an account? <a href="#" onclick="showSignInForm()">Sign In</a></p>
            </div>

            <!-- Verification Form (hidden by default) -->
            <div id="verificationForm" class="auth-form" style="display: none;">
                <p>We sent a verification code to your email</p>
                <div class="form-group">
                    <input type="text" id="verificationCode" placeholder="Enter verification code" required>
                </div>
                <button type="button" class="primary-btn" onclick="handleConfirmSignUp()">Verify</button>
                <p class="auth-switch"><a href="#" onclick="resendCode()">Resend code</a></p>
            </div>

            <!-- Divider -->
            <div class="auth-divider">
                <span>or</span>
            </div>

            <!-- Google Sign In -->
            <button type="button" class="google-btn" onclick="signInWithGoogle()">
                <svg width="18" height="18" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg">
                    <path d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z" fill="#4285F4"/>
                    <path d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z" fill="#34A853"/>
                    <path d="M3.964 10.71c-.18-.54-.282-1.117-.282-1.71s.102-1.17.282-1.71V4.958H.957C.347 6.173 0 7.548 0 9s.348 2.827.957 4.042l3.007-2.332z" fill="#FBBC05"/>
                    <path d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z" fill="#EA4335"/>
                </svg>
                Continue with Google
            </button>
        </div>

        <div id="loader" style="display:none;">
            <div class="spinner"></div>
            <p>Setting up your journal...</p>
        </div>
        <div id="authError" class="auth-error" style="display: none;"></div>
        <div class="auth-note">
            <p>Sign in with your email or Google account</p>
        </div>
    </div>

    <!-- Profile Setup for First-Time Users -->
    <div class="container profile-setup" id="profileSetup" style="display: none;">
        <h2>Let's get to know you better</h2>
        <p class="subtitle">Help us personalize your journaling experience</p>
        
        <form id="profileForm" class="profile-form">
            <div class="form-group">
                <label for="displayName">What would you like to be called?</label>
                <input type="text" id="displayName" name="displayName" placeholder="Your preferred name" required>
            </div>
            
            <div class="form-group">
                <label for="age">Your age (optional)</label>
                <select id="age" name="age">
                    <option value="">Prefer not to say</option>
                    <option value="18-25">18-25</option>
                    <option value="26-35">26-35</option>
                    <option value="36-45">36-45</option>
                    <option value="46-55">46-55</option>
                    <option value="56-65">56-65</option>
                    <option value="65+">65+</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="journalGoal">What brings you to journaling?</label>
                <select id="journalGoal" name="journalGoal" required>
                    <option value="">Select your main goal</option>
                    <option value="self-reflection">Self-reflection and mindfulness</option>
                    <option value="goal-tracking">Goal tracking and productivity</option>
                    <option value="emotional-wellness">Emotional wellness and stress relief</option>
                    <option value="creative-expression">Creative expression and writing</option>
                    <option value="memory-keeping">Memory keeping and life documentation</option>
                    <option value="habit-building">Habit building and personal growth</option>
                    <option value="other">Other</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="writingFrequency">How often do you plan to write?</label>
                <select id="writingFrequency" name="writingFrequency" required>
                    <option value="">Select frequency</option>
                    <option value="daily">Daily</option>
                    <option value="few-times-week">A few times a week</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                    <option value="when-inspired">When inspired</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="favoriteTime">When do you prefer to write?</label>
                <select id="favoriteTime" name="favoriteTime">
                    <option value="">No preference</option>
                    <option value="morning">Morning (6AM - 12PM)</option>
                    <option value="afternoon">Afternoon (12PM - 6PM)</option>
                    <option value="evening">Evening (6PM - 10PM)</option>
                    <option value="night">Night (10PM - 6AM)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="inspiration">What inspires you most?</label>
                <textarea id="inspiration" name="inspiration" placeholder="Share what motivates you, your interests, or what you'd like to explore in your journal..." rows="3"></textarea>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="primary-btn">Complete Setup</button>
                <button type="button" class="secondary-btn" onclick="skipProfile()">Skip for now</button>
            </div>
        </form>
    </div>

    <!-- Placeholder functions while module loads -->
    <script>
        // These will be replaced by the module once it loads
        window.signInWithEmail = window.signUpWithEmail = window.signInWithGoogle =
        window.handleConfirmSignUp = window.resendCode = window.skipProfile =
        window.showSignIn = window.showSignInForm = window.showSignUpForm = function() {
            console.log('Please wait, loading...');
        };
    </script>

    <!-- Cognito Auth and Application Logic -->
    <script type="module">
        // Import AWS Amplify v6 from esm.sh CDN
        import { Amplify } from 'https://esm.sh/aws-amplify@6';
        import { signIn, signUp, confirmSignUp, resendSignUpCode, signOut, getCurrentUser, fetchAuthSession, signInWithRedirect } from 'https://esm.sh/aws-amplify@6/auth';

        // Cognito Configuration
        const cognitoConfig = {
            userPoolId: 'us-west-1_81HBZnH92',
            userPoolClientId: '7t77oqaipn9hldtdpesvde3eka',
            region: 'us-west-1',
            domain: 'daybyday-journal.auth.us-west-1.amazoncognito.com'
        };

        Amplify.configure({
            Auth: {
                Cognito: {
                    userPoolId: cognitoConfig.userPoolId,
                    userPoolClientId: cognitoConfig.userPoolClientId,
                    loginWith: {
                        oauth: {
                            domain: cognitoConfig.domain,
                            scopes: ['openid', 'email', 'profile'],
                            redirectSignIn: [window.location.origin + '/journal/dashboard.html'],
                            redirectSignOut: [window.location.origin + '/journal/index.html'],
                            responseType: 'code',
                            providers: ['Google']
                        }
                    }
                }
            }
        });

        // Current user state
        let currentUser = null;
        let pendingEmail = null;

        // Check if user profile exists
        function hasUserProfile(uid) {
            return localStorage.getItem(`user_profile_${uid}`) !== null;
        }

        // Save user profile
        function saveUserProfile(uid, profileData) {
            localStorage.setItem(`user_profile_${uid}`, JSON.stringify(profileData));
        }

        // Get user profile
        function getUserProfile(uid) {
            const profile = localStorage.getItem(`user_profile_${uid}`);
            return profile ? JSON.parse(profile) : null;
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // Navigation functions
        function showSignIn() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('signInContainer').style.display = 'block';
            document.getElementById('profileSetup').style.display = 'none';
            showSignInForm();
        }

        function showSignInForm() {
            document.getElementById('signInForm').style.display = 'block';
            document.getElementById('signUpForm').style.display = 'none';
            document.getElementById('verificationForm').style.display = 'none';
        }

        function showSignUpForm() {
            document.getElementById('signInForm').style.display = 'none';
            document.getElementById('signUpForm').style.display = 'block';
            document.getElementById('verificationForm').style.display = 'none';
        }

        function showVerificationForm() {
            document.getElementById('signInForm').style.display = 'none';
            document.getElementById('signUpForm').style.display = 'none';
            document.getElementById('verificationForm').style.display = 'block';
        }

        function showProfileSetup(user) {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('signInContainer').style.display = 'none';
            document.getElementById('profileSetup').style.display = 'block';

            // Pre-fill display name if available from attributes
            if (user.username) {
                const emailPart = user.username.includes('@') ? user.username.split('@')[0] : user.username;
                document.getElementById('displayName').value = emailPart;
            }
        }

        // Auth functions
        async function signInWithEmail() {
            const email = document.getElementById('signInEmail').value;
            const password = document.getElementById('signInPassword').value;

            if (!email || !password) {
                showError('Please enter email and password');
                return;
            }

            try {
                document.getElementById('loader').style.display = 'block';
                const result = await signIn({ username: email, password });

                // Amplify v6 returns nextStep instead of isSignedIn
                if (result.isSignedIn || result.nextStep?.signInStep === 'DONE') {
                    await handleSuccessfulAuth();
                }
            } catch (error) {
                console.error('Sign in error:', error);
                if (error.name === 'UserNotConfirmedException') {
                    pendingEmail = email;
                    showVerificationForm();
                    showError('Please verify your email first');
                } else {
                    showError(error.message || 'Sign in failed');
                }
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        async function signUpWithEmail() {
            const email = document.getElementById('signUpEmail').value;
            const password = document.getElementById('signUpPassword').value;
            const confirmPassword = document.getElementById('signUpPasswordConfirm').value;

            if (!email || !password) {
                showError('Please fill in all fields');
                return;
            }

            if (password !== confirmPassword) {
                showError('Passwords do not match');
                return;
            }

            if (password.length < 8) {
                showError('Password must be at least 8 characters');
                return;
            }

            try {
                document.getElementById('loader').style.display = 'block';
                const result = await signUp({
                    username: email,
                    password,
                    options: {
                        userAttributes: {
                            email
                        }
                    }
                });

                pendingEmail = email;

                if (result.nextStep.signUpStep === 'CONFIRM_SIGN_UP') {
                    showVerificationForm();
                }
            } catch (error) {
                console.error('Sign up error:', error);
                showError(error.message || 'Sign up failed');
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        async function handleConfirmSignUp() {
            const code = document.getElementById('verificationCode').value;

            if (!code || !pendingEmail) {
                showError('Please enter the verification code');
                return;
            }

            try {
                document.getElementById('loader').style.display = 'block';
                await confirmSignUp({
                    username: pendingEmail,
                    confirmationCode: code
                });

                // Auto sign in after confirmation
                showSignInForm();
                document.getElementById('signInEmail').value = pendingEmail;
                showError('Email verified! Please sign in.');
            } catch (error) {
                console.error('Confirmation error:', error);
                showError(error.message || 'Verification failed');
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        async function resendCode() {
            if (!pendingEmail) {
                showError('Please enter your email first');
                return;
            }

            try {
                await resendSignUpCode({ username: pendingEmail });
                showError('Verification code resent!');
            } catch (error) {
                console.error('Resend error:', error);
                showError(error.message || 'Failed to resend code');
            }
        }

        async function signInWithGoogle() {
            try {
                document.getElementById('loader').style.display = 'block';
                await signInWithRedirect({ provider: 'Google' });
            } catch (error) {
                console.error('Google sign in error:', error);
                showError(error.message || 'Google sign in failed');
                document.getElementById('loader').style.display = 'none';
            }
        }

        async function handleSuccessfulAuth() {
            try {
                const user = await getCurrentUser();
                const session = await fetchAuthSession();
                const userId = session.tokens?.idToken?.payload?.sub || user.userId;

                currentUser = {
                    uid: userId,
                    email: session.tokens?.idToken?.payload?.email || user.username,
                    username: user.username
                };

                // Check if this is a first-time user
                if (!hasUserProfile(currentUser.uid)) {
                    showProfileSetup(currentUser);
                } else {
                    window.location.href = 'dashboard.html';
                }
            } catch (error) {
                console.error('Error getting user:', error);
                showError('Authentication error');
            }
        }

        // Profile form submission
        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!currentUser) {
                try {
                    const user = await getCurrentUser();
                    const session = await fetchAuthSession();
                    currentUser = {
                        uid: session.tokens?.idToken?.payload?.sub || user.userId,
                        email: session.tokens?.idToken?.payload?.email || user.username,
                        username: user.username
                    };
                } catch (error) {
                    showError('Please sign in first');
                    return;
                }
            }

            // Collect form data
            const profileData = {
                displayName: document.getElementById('displayName').value,
                age: document.getElementById('age').value,
                journalGoal: document.getElementById('journalGoal').value,
                writingFrequency: document.getElementById('writingFrequency').value,
                favoriteTime: document.getElementById('favoriteTime').value,
                inspiration: document.getElementById('inspiration').value,
                createdAt: new Date().toISOString(),
                uid: currentUser.uid,
                email: currentUser.email
            };

            // Save profile
            saveUserProfile(currentUser.uid, profileData);

            // Show success message and redirect
            showSuccessMessage(() => {
                window.location.href = 'dashboard.html';
            });
        });

        // Skip profile setup
        async function skipProfile() {
            if (!currentUser) {
                try {
                    const user = await getCurrentUser();
                    const session = await fetchAuthSession();
                    currentUser = {
                        uid: session.tokens?.idToken?.payload?.sub || user.userId,
                        email: session.tokens?.idToken?.payload?.email || user.username,
                        username: user.username
                    };
                } catch (error) {
                    showError('Please sign in first');
                    return;
                }
            }

            // Save minimal profile
            const profileData = {
                displayName: currentUser.email?.split('@')[0] || 'User',
                age: '',
                journalGoal: '',
                writingFrequency: '',
                favoriteTime: '',
                inspiration: '',
                createdAt: new Date().toISOString(),
                uid: currentUser.uid,
                email: currentUser.email,
                skipped: true
            };

            saveUserProfile(currentUser.uid, profileData);
            window.location.href = 'dashboard.html';
        }

        // Success message
        function showSuccessMessage(callback) {
            const profileSetup = document.getElementById('profileSetup');
            profileSetup.innerHTML = `
                <div class="success-message">
                    <div class="success-icon">âœ“</div>
                    <h2>Welcome to Day by Day!</h2>
                    <p>Your profile has been created successfully.</p>
                    <p>Let's start your journaling journey...</p>
                </div>
            `;

            setTimeout(callback, 2000);
        }

        // Check authentication state on page load
        async function checkAuthState() {
            try {
                const user = await getCurrentUser();
                const session = await fetchAuthSession();
                const userId = session.tokens?.idToken?.payload?.sub || user.userId;

                currentUser = {
                    uid: userId,
                    email: session.tokens?.idToken?.payload?.email || user.username,
                    username: user.username
                };

                // User is signed in
                if (hasUserProfile(currentUser.uid)) {
                    // Existing user - redirect to dashboard
                    window.location.href = 'dashboard.html';
                } else {
                    // New user - show profile setup
                    showProfileSetup(currentUser);
                }
            } catch (error) {
                // Not signed in - show sign in form directly
                console.log('Not authenticated:', error.message);
                showSignIn();
            }
        }

        async function signOutUser() {
            try {
                await signOut();
                currentUser = null;
                showSignIn();
            } catch (error) {
                console.error('Sign out error:', error);
            }
        }

        // Initialize on page load
        checkAuthState();

        // Expose functions to window for onclick handlers (ES modules have their own scope)
        window.showSignIn = showSignIn;
        window.showSignInForm = showSignInForm;
        window.showSignUpForm = showSignUpForm;
        window.signInWithEmail = signInWithEmail;
        window.signUpWithEmail = signUpWithEmail;
        window.handleConfirmSignUp = handleConfirmSignUp;
        window.resendCode = resendCode;
        window.signInWithGoogle = signInWithGoogle;
        window.skipProfile = skipProfile;
    </script>

</body>
</html>
